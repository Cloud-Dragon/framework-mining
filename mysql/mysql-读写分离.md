# mysql读写分离



将数据库（主节点）中数据通过某种方式同步至其他数据库实例（从节点）中，对于写操作，由主节点完成，再同步至其他从节点；对于读操作，由从节点和主节点完成，这就是读写分离。

## 作用

- **水平扩展数据库读能力**，将原来单个节点的读分散到多个节点上，减小单个数据库实例读压力
- **数据库灾备**，增加数据库实例，同步当前数据库信息，可以在某个数据库实例挂掉之后进行替换，实现数据的容灾备份。

## 架构

### M/S (master/slave，主从) 架构

最典型的架构，也是最常用的架构，数据写入主节点之后立即返回给客户端，通过同步binlog日志异步复制到从节点，实现数据的同步。

既然是异步就会存在数据延迟的问题，实际上大多数业务是能够容忍同步延迟的，而对于无法容忍延迟的场景可以通过强制走主库实现。

### MGR (Mysql Group Replication，组复制) 架构

Mysql Group Replication由至少3个或更多个节点共同组成一个数据库集群，事务的提交必须经过半数以上节点同意方可提交，在集群中每个节点上都维护一个数据库状态机，保证节点间事务的一致性。Group Replication基于分布式一致性算法Paxos实现，允许部分节点故障，只要保证半数以上节点存活，就不影响对外提供数据库服务，是一个真正可用的高可用数据库集群技术。Group Replication支持两种模式，单主模式和多主模式。在同一个group内，不允许两种模式同时存在，并且若要切换到不同模式，必须修改配置后重新启动集群。在单主模式下，只有一个节点可以对外提供读写事务的服务，而其它所有节点只能提供只读事务的服务，这也是官方推荐的Group Replication复制模式。

相比于M/S架构的异步复制，MGR方式可以理解为同步复制，这样可以最大程度保证数据一致性，但同时由于数据同步至多数节点才会返回，也导致了写性能相比于M/S架构会有所下降

两种方式对比如下



## 使用

### 环境搭建(数据库层面)



### 应用(应用层面)

既然扩展多个节点，该如何控制应用服务的读写呢，这就需要借助数据库中间件来实现，当前有很多数据库中间件，根据实现原理大致可以分为两种

#### 客户端方式

应用通过引入客户端，在客户端选择相应的数据库连接进行处理，典型的组件有当当开源的Sharing-JDBC，美团开源的zebra。

- 优点
  - 直连数据库，性能更好
- 缺点
  - 逻辑全都在客户端代码中，需推动客户端升级
  - 多种变成语言需重复开发

#### Proxy方式

应用请求会发送到一个代理中心，由中心进行路由转发，典型的组件有Atlas。

- 优点 
  - 减少客户端依赖，所有逻辑集中在proxy，升级无感知
- 缺点：
  - 性能略差，由于多一次跳转，增加网络开销，性能会比客户端直连稍差
  - 可用性问题，单点故障问题，当proxy挂掉将会导致数据库无法访问，因此proxy的高可用尤其重要

两种方式优缺点比较



## 原理

通过mysql binlog将数据数据同步到从库，