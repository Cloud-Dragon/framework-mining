# 分布式一致性协议







### 2PC（Two-Phase Commit，二阶段提交）

二阶段提交是一种强一致性性协议

#### 角色：

- 协调者：
- 参与者：

#### 阶段：

表决阶段(Voting)和提交阶段(Commit)

表决阶段



特点

应用



#### 存在问题

1、同步阻塞

所有参与该事务操作的逻辑都处理于阻塞状态。即节点之间在等待对方的相应消息时，它将什么也做不了。特别是，当一个节点在已经占有了某项资源的情况下，为了等待其他节点的响应消息而陷入阻塞状态时，当第三个节点尝试访问该节点占有的资源时，这个节点也将连带陷入阻塞状态。

2、 单点问题

一旦协调者出现问题，那么整个二阶段提交流程将无法运转，更为严重的是，如果协调者是在阶段二中出现问题的话，那么其他参与者将会一直处于锁定事务资源的状态中，而无法继续完成事务操作。

3、 数据不一致

当协调者向所有的参与者发送Commit请求之后发生了局部网络异常或者是协调者在尚未发送完Commit请求之前自身发生了崩贵，导致最终只有部分参与者收到了Commit请求，于是整个分布式系统便出现了数据不一致性现象。

3、太过保守

二阶段提交没有设计较为完善的容错机制，任意一个节点的失败都会导致整个事务的失败。



### 3PC（Three-Phase Commit，三阶段提交）

3PC就是在2PC基础上将2PC的提交阶段细分位两个阶段：预提交阶段和提交阶段。由CanCommit、PreCommit和doCommit三个阶段组成的事务处理协议。



与2PC相比

- 增加了一个询问阶段，询问阶段可以确保尽可能早的发现无法执行操作而需要中止的行为，但是它并不能发现所有的这种行为，只会减少这种情况的发生。
- 在准备阶段以后，协调者和参与者执行的任务中都增加了超时，一旦超时，协调者和参与者都继续提交事务，默认为成功，这也是根据概率统计上超时后默认成功的正确性最大。



#### 存在问题：

三阶段提交协议在去除阻塞的同时也引入了新的问题，那就是在参与者接收到preCommit消息后，如果网络出现分区，此时协调者所在的节点和参与者无法进行正常的网络通信，在这种情况下，该参与者依然会进行事务的提交，这必然出现数据的不一致性。



### 向量时钟



### NWR协议



###  paxos协议



### Raft协议



### ZAB协议(Zookeeper Atomic Broadcast，zookeeper原子广播协议)

ZAB(Zookeeper Atomic Broadcast)